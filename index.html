<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒœãƒˆãƒ«ç®¡ç†ï¼ˆå…±æœ‰ç‰ˆï¼‰</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f2f2f2; }
    input, button, textarea { padding: 8px; margin: 5px; font-size: 16px; }
    .entry { background: white; padding: 10px; margin: 5px 0; border-radius: 5px; position: relative; }
    .delete-btn { color: red; cursor: pointer; margin-left: 10px; }
    textarea { vertical-align: middle; resize: vertical; }
    .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: #ccc; }
    .tab-btn.active { background: #666; color: white; }
    .section { display: none; }
    .section.active { display: block; margin-top: 20px; }
    @media (max-width: 600px) {
      input, button, textarea { width: 100%; box-sizing: border-box; margin: 8px 0; }
      .tab-btn { width: 50%; font-size: 16px; }
      .entry { font-size: 16px; }
    }
    button.save-btn { position: absolute; top: 8px; right: 60px; }
    button.edit-btn { position: absolute; top: 8px; right: 120px; }
    button.delete-btn { position: absolute; top: 8px; right: 10px; }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script>
  /* global firebase */

  // FirebaseåˆæœŸåŒ–
  const firebaseConfig = {
    apiKey: "AIzaSyDAHavEv8va5f9W-6Tl7UGwLs_27-Vm7yU",
    authDomain: "bottle-app-ad02e.firebaseapp.com",
    projectId: "bottle-app-ad02e",
    storageBucket: "bottle-app-ad02e.firebasestorage.app",
    messagingSenderId: "92055103267",
    appId: "1:92055103267:web:4bff00001bd81dee9d0e96"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  </script>
</head>
<body>
  <h1>ãƒœãƒˆãƒ«ç®¡ç†ï¼ˆå…±æœ‰ç‰ˆï¼‰</h1>

  <div>
    <button class="tab-btn active" onclick="showSection('search')">ğŸ” æ¤œç´¢</button>
    <button class="tab-btn" onclick="showSection('register')">ğŸ“ ç™»éŒ²</button>
  </div>

  <div id="search" class="section active">
    <h3>ãŠå®¢æ§˜ã§æ¤œç´¢</h3>
    <input type="text" id="searchInput" placeholder="åå‰ã§æ¤œç´¢" oninput="loadEntries()">
    <h2>ä¸€è¦§</h2>
    <div id="list"></div>
  </div>

  <div id="register" class="section">
    <h3>æ–°è¦ç™»éŒ²</h3>
    <input type="text" id="name" placeholder="ãŠå®¢æ§˜ã®åå‰"><br>
    <input type="text" id="bottle" placeholder="ãƒœãƒˆãƒ«å"><br>
    <input type="text" id="account" placeholder="å£åº§"><br>
    <textarea id="note" placeholder="å‚™è€ƒ" rows="2"></textarea><br>
    <input type="date" id="visitDate"><br>
    <button onclick="addEntry()">ç™»éŒ²</button>
  </div>

<script>
  const listDiv = document.getElementById("list");
  let editStates = {}; // idã‚’ã‚­ãƒ¼ã«ç·¨é›†çŠ¶æ…‹ã‚’ç®¡ç†

  function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.target.classList.add('active');
    if (id === "search") loadEntries();
  }

  // Firestoreã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«å–å¾—ã—ã¦è¡¨ç¤º
  function loadEntries() {
    const search = document.getElementById("searchInput").value.toLowerCase();
    db.collection("bottles").orderBy("name").onSnapshot(snapshot => {
      listDiv.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const id = doc.id;
        if (!data.name.toLowerCase().includes(search)) return;

        const isEditing = editStates[id] || false;
        const div = document.createElement("div");
        div.className = "entry";

        if (isEditing) {
          div.innerHTML = `
            åå‰: <input type="text" id="nameInput-${id}" value="${data.name}"><br>
            ãƒœãƒˆãƒ«å: <input type="text" id="bottleInput-${id}" value="${data.bottle}"><br>
            å£åº§: <input type="text" id="accountInput-${id}" value="${data.account || ''}" placeholder="ãªã—"><br>
            å‚™è€ƒ: <input type="text" id="noteInput-${id}" value="${data.note || ''}" placeholder="ãªã—"><br>
            æœ€çµ‚æ¥åº—æ—¥: ${data.visitDate || 'æœªè¨˜å…¥'}
            <input type="date" id="visitInput-${id}" value="${data.visitDate || ''}"><br>
            <button class="save-btn" onclick="submitAllUpdates('${id}')">ä¿å­˜</button>
            <button class="delete-btn" onclick="confirmDelete('${id}')">å‰Šé™¤</button>
          `;
        } else {
          div.innerHTML = `
            åå‰: ${data.name}<br>
            ãƒœãƒˆãƒ«å: ${data.bottle}<br>
            å£åº§: ${data.account || 'ãªã—'}<br>
            å‚™è€ƒ: ${data.note || 'ãªã—'}<br>
            æœ€çµ‚æ¥åº—æ—¥: ${data.visitDate || 'æœªè¨˜å…¥'}
            <button class="edit-btn" onclick="toggleEdit('${id}')">ç·¨é›†</button>
            <button class="delete-btn" onclick="confirmDelete('${id}')">å‰Šé™¤</button>
          `;
        }

        listDiv.appendChild(div);
      });
    });
  }

  function toggleEdit(id) {
    editStates[id] = true;
    loadEntries();
  }

  async function submitAllUpdates(id) {
    const name = document.getElementById(`nameInput-${id}`).value.trim();
    const bottle = document.getElementById(`bottleInput-${id}`).value.trim();
    const account = document.getElementById(`accountInput-${id}`).value.trim();
    const note = document.getElementById(`noteInput-${id}`).value.trim();
    const visitDate = document.getElementById(`visitInput-${id}`).value;

    if (!name || !bottle) {
      alert("åå‰ã¨ãƒœãƒˆãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    try {
      await db.collection("bottles").doc(id).update({ name, bottle, account, note, visitDate });
      editStates[id] = false;
      loadEntries();
    } catch (e) {
      alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
    }
  }

  async function addEntry() {
    const name = document.getElementById("name").value.trim();
    const bottle = document.getElementById("bottle").value.trim();
    const account = document.getElementById("account").value.trim();
    const note = document.getElementById("note").value.trim();
    const visitDate = document.getElementById("visitDate").value;

    if (!name || !bottle) {
      alert("åå‰ã¨ãƒœãƒˆãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    try {
      await db.collection("bottles").add({ name, bottle, account, note, visitDate });
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
      document.getElementById("name").value = "";
      document.getElementById("bottle").value = "";
      document.getElementById("account").value = "";
      document.getElementById("note").value = "";
      document.getElementById("visitDate").value = "";

      showSection("search");
      loadEntries();
    } catch (e) {
      alert("ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
    }
  }

  async function confirmDelete(id) {
    if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    try {
      await db.collection("bottles").doc(id).delete();
    } catch (e) {
      alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
    }
  }

  // åˆæœŸè¡¨ç¤º
  loadEntries();
</script>
</body>
</html>